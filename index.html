<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multi Scan QR</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    #reader { width: 300px; margin: auto; }
    button { margin: 10px; padding: 10px; }
  </style>
</head>
<body>
  <h2>QR Scanner 01</h2>
  <div id="reader"></div>
  <button onclick="startScan()">Start Scan</button>
  <button onclick="submitAll()">Submit All</button>
  <p id="status"></p>

  <script>
    let scannedData = []; // 暫存掃描結果
    let html5QrCode;      // 掃描器物件
    const qrRegionId = "reader";

    // ✅ 開始掃描
    function startScan() {
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {}); // 確保乾淨狀態
      }
      html5QrCode = new Html5Qrcode(qrRegionId);

      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          // 防止重複
          if (!scannedData.includes(decodedText)) {
            scannedData.push(decodedText);
            document.getElementById("status").innerText =
              `Scanned: ${decodedText} (${scannedData.length}/8)`;
          }

          // 如果已經掃 8 次，自動停止
          if (scannedData.length >= 8) {
            stopScan();
            document.getElementById("status").innerText =
              "已完成 8 次掃描，請提交。";
          }
        }
      ).catch(err => {
        console.error("Scan error:", err);
      });
    }

    // ✅ 停止掃描
    function stopScan() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          console.log("Scanner stopped.");
        }).catch(err => {
          console.warn("Stop failed:", err);
        });
      }
    }

    // ✅ 一次提交 8 筆資料
    function submitAll() {
      if (scannedData.length < 8) {
        alert("需要先掃滿 8 次再提交！");
        return;
      }

      fetch("https://script.google.com/macros/s/AKfycbySUdg-CFcN1tcKhpikMcsd-5JG5Vhn650AQWVWWLd2DzpDmiwfu1J7UgpIu4z708uu/exec", {
        method: "POST",
        body: JSON.stringify({
          qrData: scannedData
        }),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(result => {
        document.getElementById("status").innerText =
          "上傳成功 ✅：" + JSON.stringify(result);
        scannedData = []; // 清空以便下一輪
      })
      .catch(err => {
        console.error("上傳失敗:", err);
        document.getElementById("status").innerText = "上傳失敗 ❌";
      });
    }
  </script>
</body>
</html>
