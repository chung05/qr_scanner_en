<script>
  const url = "https://script.google.com/macros/s/AKfycbySUdg-CFcN1tcKhpikMcsd-5JG5Vhn650AQWVWWLd2DzpDmiwfu1J7UgpIu4z708uu/exec";

  let records = {
    "A棟B2": null,
    "A棟9F": null,
    "B棟B2": null,
    "B棟9F": null
  };

  let html5QrCode = null;
  let isScanning = false;

  async function startScan(location) {
    // 如果有舊的 scanner 且正在掃描 → 停止
    if (html5QrCode && isScanning) {
      await html5QrCode.stop().catch(() => {});
      isScanning = false;
    }

    html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      qrCodeMessage => {
        const now = new Date().toLocaleString();
        records[location] = { location, qrCode: qrCodeMessage, time: now };
        document.getElementById(location + "-record").innerText = now + " - " + qrCodeMessage;

        // 停止掃描前要檢查狀態
        if (isScanning) {
          html5QrCode.stop().catch(() => {});
          isScanning = false;
        }
      },
      errorMessage => { console.log("Scanning..."); }
    ).then(() => {
      isScanning = true;
    }).catch(err => console.error("Camera start error:", err));
  }

  async function submitAll() {
    const data = Object.values(records).filter(r => r !== null);

    if (data.length === 0) {
      document.getElementById("upload-status").innerText = "⚠️ 沒有資料可上傳";
      return;
    }

    try {
      const response = await fetch(url, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      document.getElementById("upload-status").innerText = "✅ 上傳成功：" + result.message;
    } catch (error) {
      console.error("上傳失敗:", error);
      document.getElementById("upload-status").innerText = "❌ 上傳失敗";
    }
  }
</script>
